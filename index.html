<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limpiador de CSV para Estudiantes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-8">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-lg shadow-xl p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">
                    Limpiador de CSV para Estudiantes
                </h1>
                <p class="text-gray-600">
                    Sube tu archivo CSV y obtén una versión limpia lista para cargar
                </p>
            </div>

            <div class="mb-8">
                <label for="fileInput" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-indigo-500 hover:bg-indigo-50 transition">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <svg class="w-10 h-10 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <p class="text-sm text-gray-600" id="fileName">
                            Click para subir archivo CSV
                        </p>
                    </div>
                    <input type="file" id="fileInput" accept=".csv" class="hidden">
                </label>
            </div>

            <div id="loading" class="text-center py-8 hidden">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                <p class="mt-4 text-gray-600">Analizando archivo...</p>
            </div>

            <div id="results" class="hidden">
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            Errores Detectados (<span id="errorCount">0</span>)
                        </h2>
                    </div>
                    
                    <div id="errorContainer"></div>
                </div>

                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Vista Previa (Primeros 5 registros)
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">Nombre</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">Email</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">Username</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">Password</th>
                                </tr>
                            </thead>
                            <tbody id="previewTable"></tbody>
                        </table>
                        <p id="moreRecords" class="text-sm text-gray-600 mt-2"></p>
                    </div>
                </div>

                <div class="flex justify-center">
                    <button id="downloadBtn" class="flex items-center bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition font-semibold">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Descargar CSV Limpio
                    </button>
                </div>

                <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p class="text-sm text-blue-800">
                        <strong>Total de registros procesados:</strong> <span id="totalRecords">0</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let cleanedData = [];
        let errors = [];

        const removeAccents = (str) => {
            return str
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/ñ/g, 'n')
                .replace(/Ñ/g, 'N');
        };

        const cleanString = (str) => {
            return str
                .replace(/\r/g, '')
                .replace(/\s+/g, ' ')
                .trim();
        };

        const validateEmail = (email) => {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        };

        const processCSV = (text) => {
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length === 0) return [];

            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].trim() : '';
                    });
                    data.push(row);
                }
            }

            return data;
        };

        const analyzeAndClean = (data) => {
            const foundErrors = [];
            const cleaned = [];
            const seenEmails = new Set();
            const seenUsernames = new Set();

            data.forEach((row, index) => {
                const rowNum = index + 2;
                const cleanedRow = { ...row };

                // Limpiar nombre
                if (row.name) {
                    cleanedRow.name = cleanString(row.name);
                } else {
                    foundErrors.push(`Fila ${rowNum}: El campo 'name' está vacío`);
                }

                // Limpiar y validar email
                if (row.email) {
                    const originalEmail = row.email;
                    let cleanedEmail = cleanString(row.email);
                    cleanedEmail = removeAccents(cleanedEmail).toLowerCase();
                    cleanedEmail = cleanedEmail.replace(/\s+/g, '');
                    cleanedRow.email = cleanedEmail;

                    if (originalEmail !== cleanedEmail) {
                        foundErrors.push(`Fila ${rowNum}: Email corregido de "${originalEmail}" a "${cleanedEmail}"`);
                    }

                    if (!validateEmail(cleanedEmail)) {
                        foundErrors.push(`Fila ${rowNum}: Email inválido "${cleanedEmail}"`);
                    }

                    if (seenEmails.has(cleanedEmail)) {
                        foundErrors.push(`Fila ${rowNum}: Email duplicado "${cleanedEmail}"`);
                    }
                    seenEmails.add(cleanedEmail);
                } else {
                    foundErrors.push(`Fila ${rowNum}: El campo 'email' está vacío`);
                }

                // Limpiar y validar username
                if (row.username) {
                    const originalUsername = row.username;
                    let cleanedUsername = cleanString(row.username);
                    // Primero eliminar acentos
                    cleanedUsername = removeAccents(cleanedUsername);
                    // Convertir a minúsculas
                    cleanedUsername = cleanedUsername.toLowerCase();
                    // Eliminar espacios
                    cleanedUsername = cleanedUsername.replace(/\s+/g, '');
                    // Eliminar cualquier caracter que NO sea letra, número, punto, guión o guión bajo
                    cleanedUsername = cleanedUsername.replace(/[^a-z0-9._-]/g, '');
                    cleanedRow.username = cleanedUsername;

                    if (originalUsername !== cleanedUsername) {
                        foundErrors.push(`Fila ${rowNum}: Username corregido de "${originalUsername}" a "${cleanedUsername}"`);
                    }

                    // Validar que el username solo contenga caracteres permitidos
                    if (!/^[a-z0-9._-]+$/.test(cleanedUsername)) {
                        foundErrors.push(`Fila ${rowNum}: Username contiene caracteres no permitidos "${cleanedUsername}"`);
                    }

                    if (seenUsernames.has(cleanedUsername)) {
                        foundErrors.push(`Fila ${rowNum}: Username duplicado "${cleanedUsername}"`);
                    }
                    seenUsernames.add(cleanedUsername);
                } else {
                    foundErrors.push(`Fila ${rowNum}: El campo 'username' está vacío`);
                }

                // Validar password
                if (row.password) {
                    cleanedRow.password = cleanString(row.password);
                    if (cleanedRow.password.length < 8) {
                        foundErrors.push(`Fila ${rowNum}: Password debe tener al menos 8 caracteres (actual: ${cleanedRow.password.length})`);
                    }
                } else {
                    foundErrors.push(`Fila ${rowNum}: El campo 'password' está vacío`);
                }

                cleaned.push(cleanedRow);
            });

            return { cleaned, foundErrors };
        };

        const displayResults = () => {
            document.getElementById('errorCount').textContent = errors.length;
            
            const errorContainer = document.getElementById('errorContainer');
            if (errors.length > 0) {
                errorContainer.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 max-h-64 overflow-y-auto">
                        <ul class="space-y-1 text-sm">
                            ${errors.map(error => `<li class="text-red-700">• ${error}</li>`).join('')}
                        </ul>
                    </div>
                `;
            } else {
                errorContainer.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center text-green-700">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span>¡No se encontraron errores! El archivo está perfecto.</span>
                        </div>
                    </div>
                `;
            }

            const previewTable = document.getElementById('previewTable');
            previewTable.innerHTML = cleanedData.slice(0, 5).map(row => `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-300 px-4 py-2 text-sm">${row.name || ''}</td>
                    <td class="border border-gray-300 px-4 py-2 text-sm">${row.email || ''}</td>
                    <td class="border border-gray-300 px-4 py-2 text-sm">${row.username || ''}</td>
                    <td class="border border-gray-300 px-4 py-2 text-sm">${row.password || ''}</td>
                </tr>
            `).join('');

            const moreRecords = document.getElementById('moreRecords');
            if (cleanedData.length > 5) {
                moreRecords.textContent = `... y ${cleanedData.length - 5} registros más`;
            } else {
                moreRecords.textContent = '';
            }

            document.getElementById('totalRecords').textContent = cleanedData.length;
            document.getElementById('results').classList.remove('hidden');
        };

        const downloadCSV = () => {
            const headers = ['name', 'email', 'username', 'password'];
            const csvContent = [
                headers.join(','),
                ...cleanedData.map(row => 
                    headers.map(header => row[header] || '').join(',')
                )
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'estudiantes_limpio.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('fileName').textContent = file.name;
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');

            const reader = new FileReader();
            reader.onload = (event) => {
                const text = event.target.result;
                const parsed = processCSV(text);
                const result = analyzeAndClean(parsed);
                
                cleanedData = result.cleaned;
                errors = result.foundErrors;
                
                document.getElementById('loading').classList.add('hidden');
                displayResults();
            };
            reader.readAsText(file);
        });

        document.getElementById('downloadBtn').addEventListener('click', downloadCSV);
    </script>
</body>
</html>
